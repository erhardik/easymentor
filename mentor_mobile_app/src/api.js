import { DEFAULT_API_BASE_URL } from "./constants";

let CURRENT_API_BASE_URL = DEFAULT_API_BASE_URL;

export function setApiBaseUrl(url) {
  const next = String(url || "").trim().replace(/\/+$/, "");
  if (next) {
    CURRENT_API_BASE_URL = next;
  }
}

export function getApiBaseUrl() {
  return CURRENT_API_BASE_URL;
}

async function request(path, options = {}, token = "") {
  const headers = {
    "Content-Type": "application/json",
    ...(options.headers || {}),
  };
  if (token) {
    headers.Authorization = `Bearer ${token}`;
  }
  const response = await fetch(`${CURRENT_API_BASE_URL}${path}`, {
    ...options,
    headers,
  });
  const data = await response.json();
  if (!response.ok || data.ok === false) {
    throw new Error(data.msg || "Request failed");
  }
  return data;
}

export function login(mentor, password) {
  return request("/api/mobile/login/", {
    method: "POST",
    body: JSON.stringify({ mentor, password }),
  });
}

export function logout(token) {
  return request("/api/mobile/logout/", { method: "POST", body: "{}" }, token);
}

export function getModules(token, moduleId = "") {
  const query = moduleId ? `?module_id=${moduleId}` : "";
  return request(`/api/mobile/modules/${query}`, { method: "GET" }, token);
}

export function getWeeks(token, moduleId) {
  return request(`/api/mobile/weeks/?module_id=${moduleId}`, { method: "GET" }, token);
}

export function getCalls(token, week, moduleId) {
  return request(`/api/mobile/calls/?week=${week}&module_id=${moduleId}`, { method: "GET" }, token);
}

export function saveCall(token, payload) {
  return request(
    "/api/mobile/save-call/",
    { method: "POST", body: JSON.stringify(payload) },
    token
  );
}

export function getRetryList(token, week, moduleId) {
  return request(`/api/mobile/retry-list/?week=${week}&module_id=${moduleId}`, { method: "GET" }, token);
}

export function markMessage(token, id, moduleId) {
  return request(
    "/api/mobile/mark-message/",
    { method: "POST", body: JSON.stringify({ id, module_id: moduleId }) },
    token
  );
}

export function getResultCycles(token, moduleId) {
  return request(`/api/mobile/result-cycles/?module_id=${moduleId}`, { method: "GET" }, token);
}

export function getResultCalls(token, uploadId = "", moduleId = "") {
  const query = uploadId ? `?upload_id=${uploadId}&module_id=${moduleId}` : `?module_id=${moduleId}`;
  return request(`/api/mobile/result-calls/${query}`, { method: "GET" }, token);
}

export function saveResultCall(token, payload) {
  return request(
    "/api/mobile/save-result-call/",
    { method: "POST", body: JSON.stringify(payload) },
    token
  );
}

export function getResultRetryList(token, uploadId, moduleId) {
  return request(`/api/mobile/result-retry-list/?upload_id=${uploadId}&module_id=${moduleId}`, { method: "GET" }, token);
}

export function markResultMessage(token, id, moduleId) {
  return request(
    "/api/mobile/mark-result-message/",
    { method: "POST", body: JSON.stringify({ id, module_id: moduleId }) },
    token
  );
}

export function getResultReport(token, uploadId = "", moduleId = "") {
  const query = uploadId ? `?upload_id=${uploadId}&module_id=${moduleId}` : `?module_id=${moduleId}`;
  return request(`/api/mobile/result-report/${query}`, { method: "GET" }, token);
}

export function getOtherCalls(token, moduleId) {
  return request(`/api/mobile/other-calls/?module_id=${moduleId}`, { method: "GET" }, token);
}

export function saveOtherCall(token, payload) {
  return request(
    "/api/mobile/save-other-call/",
    { method: "POST", body: JSON.stringify(payload) },
    token
  );
}
