{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Other Calls - {{mentor.name}}</h3>
</div>

{% if not records %}
<div class="alert alert-info">No mentees found.</div>
{% endif %}

<div class="desktop-view">
<div class="table-responsive">
<table class="table table-bordered table-hover align-middle">
<thead class="table-dark text-center">
<tr>
<th>Roll</th>
<th>Enrollment</th>
<th>Name</th>
<th>Status</th>
<th>Call Student</th>
<th>Call Father</th>
</tr>
</thead>
<tbody>
{% for c in records %}
<tr>
<td>{{c.student.roll_no}}</td>
<td>{{c.student.enrollment}}</td>
<td>{{c.student.name}}</td>
<td class="text-center">
    {% if c.final_status == "received" %}
        <span class="badge bg-success">Received</span>
    {% elif c.final_status == "not_received" %}
        <span class="badge bg-warning text-dark">Not Received</span>
    {% else %}
        <span class="badge bg-primary">Pending</span>
    {% endif %}
</td>
<td class="text-center">
    <button class="btn btn-primary call-btn"
        data-id="{{c.id}}"
        data-target="student"
        data-phone="{{c.student.student_mobile}}">
        Call Student
    </button>
</td>
<td class="text-center">
    <button class="btn btn-success call-btn"
        data-id="{{c.id}}"
        data-target="father"
        data-phone="{{c.student.father_mobile|default:c.student.mother_mobile}}">
        Call Father
    </button>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>

<div class="mobile-view">
{% for c in records %}
<div class="card shadow-sm mb-3">
    <div class="card-body p-3">
        <div class="fw-bold fs-6">{{c.student.roll_no}} - {{c.student.name}}</div>
        <div class="text-muted small mb-2">{{c.student.enrollment}}</div>
        <div class="mb-2">
            {% if c.final_status == "received" %}
                <span class="badge bg-success">Received</span>
            {% elif c.final_status == "not_received" %}
                <span class="badge bg-warning text-dark">Not Received</span>
            {% else %}
                <span class="badge bg-primary">Pending</span>
            {% endif %}
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary w-50 call-btn"
                    data-id="{{c.id}}"
                    data-target="student"
                    data-phone="{{c.student.student_mobile}}">
                Call Student
            </button>
            <button class="btn btn-success w-50 call-btn"
                    data-id="{{c.id}}"
                    data-target="father"
                    data-phone="{{c.student.father_mobile|default:c.student.mother_mobile}}">
                Call Father
            </button>
        </div>
    </div>
</div>
{% endfor %}
</div>

<script>
const PENDING_OTHER_CALL_KEY = "pending_other_call";
let modalShownForPending = false;

function getPendingCall(){
    try{
        return JSON.parse(localStorage.getItem(PENDING_OTHER_CALL_KEY) || "null");
    }catch(e){
        return null;
    }
}
function setPendingCall(data){
    localStorage.setItem(PENDING_OTHER_CALL_KEY, JSON.stringify(data));
    modalShownForPending = false;
}
function clearPendingCall(){
    localStorage.removeItem(PENDING_OTHER_CALL_KEY);
    modalShownForPending = false;
}

function openCallResultModalIfPending(){
    const pending = getPendingCall();
    if(!pending || modalShownForPending){
        return;
    }
    if(!pending.id){
        clearPendingCall();
        return;
    }

    const startedAt = Number(pending.started_at || 0);
    const elapsedSec = startedAt ? Math.max(0, Math.round((Date.now() - startedAt) / 1000)) : 0;
    const estimatedMinutes = elapsedSec ? Math.max(1, Math.round(elapsedSec / 60)) : "";

    document.getElementById("call_id").value = pending.id;
    document.getElementById("call_target").value = pending.target || "";
    document.getElementById("duration").value = estimatedMinutes;
    document.getElementById("autoDurationNote").innerText =
        elapsedSec ? `Auto-estimated duration: ${elapsedSec}s (editable)` : "";

    modalShownForPending = true;
    new bootstrap.Modal(document.getElementById("callResultModal")).show();
}

document.querySelectorAll(".call-btn").forEach(btn => {
    btn.addEventListener("click", function(){
        const phone = (this.dataset.phone || "").trim();
        const callId = this.dataset.id;
        const target = this.dataset.target || "";
        if(!phone){
            alert("Number not available");
            return;
        }
        setPendingCall({ id: callId, phone: phone, target: target, started_at: Date.now() });
        window.location.href = "tel:" + phone;
    });
});

window.addEventListener("focus", function(){ setTimeout(openCallResultModalIfPending, 350); });
window.addEventListener("pageshow", function(){ setTimeout(openCallResultModalIfPending, 350); });
document.addEventListener("visibilitychange", function(){
    if(document.visibilityState === "visible"){
        setTimeout(openCallResultModalIfPending, 350);
    }
});

function markReceived(){
    let id = document.getElementById("call_id").value;
    let target = document.getElementById("call_target").value;
    let talked = document.getElementById("talked").value;
    let duration = document.getElementById("duration").value;
    let remark = document.getElementById("remark").value;
    let callReason = document.getElementById("call_reason").value;

    fetch("/save-other-call/",{
        method:"POST",
        headers:{
            "Content-Type":"application/x-www-form-urlencoded",
            "X-CSRFToken":"{{csrf_token}}"
        },
        body:`id=${id}&target=${target}&status=received&talked=${talked}&duration=${duration}&remark=${encodeURIComponent(remark)}&call_reason=${encodeURIComponent(callReason)}`
    }).then(()=>{ clearPendingCall(); location.reload(); });
}

function markNotReceived(){
    let id = document.getElementById("call_id").value;
    let target = document.getElementById("call_target").value;
    let callReason = document.getElementById("call_reason").value;
    fetch("/save-other-call/",{
        method:"POST",
        headers:{
            "Content-Type":"application/x-www-form-urlencoded",
            "X-CSRFToken":"{{csrf_token}}"
        },
        body:`id=${id}&target=${target}&status=not_received&call_reason=${encodeURIComponent(callReason)}`
    }).then(()=>{ clearPendingCall(); location.reload(); });
}
</script>

<div class="modal fade" id="callResultModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Other Call Result</h5>
      </div>
      <div class="modal-body">
        <input type="hidden" id="call_id">
        <input type="hidden" id="call_target">

        <div class="mb-2">
            <label>Talked With</label>
            <select id="talked" class="form-control">
                <option value="student">Student</option>
                <option value="father">Father</option>
                <option value="mother">Mother</option>
                <option value="guardian">Guardian</option>
            </select>
        </div>
        <div class="mb-2">
            <label>Duration (minutes)</label>
            <input type="number" id="duration" class="form-control" min="1">
            <small id="autoDurationNote" class="text-muted"></small>
        </div>
        <div class="mb-2">
            <label>Parents Remark</label>
            <input type="text" id="remark" class="form-control">
        </div>
        <div class="mb-2">
            <label>Call Done Reason</label>
            <input type="text" id="call_reason" class="form-control">
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success w-100" onclick="markReceived()">Received</button>
            <button class="btn btn-warning w-100" onclick="markNotReceived()">Not Received</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
