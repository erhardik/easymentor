{% extends "base.html" %}
{% load get_item %}
{% block content %}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Welcome {{mentor.name}}</h3>

    {% if selected_week %}
        <span class="badge bg-danger fs-6">Week-{{selected_week}}</span>
    {% endif %}
</div>


<!-- WEEK BUTTONS -->
<div class="mb-3 d-flex flex-wrap gap-2">

{% for w in weeks %}
    {% if w == selected_week %}
        <a href="?week={{w}}" class="btn btn-dark btn-sm">Week-{{w}}</a>
    {% else %}
        <a href="?week={{w}}" class="btn btn-outline-primary btn-sm">Week-{{w}}</a>
    {% endif %}
{% endfor %}

</div>


{% if not records %}
<div class="alert alert-success">
    ðŸŽ‰ All students above 80% â€” No calls required
</div>
{% endif %}


<!-- ================= DESKTOP TABLE ================= -->
<div class="desktop-view">

<div class="table-responsive">
<table class="table table-bordered table-hover align-middle">

<thead class="table-dark text-center">
<tr>
<th>Roll</th>
<th>Enrollment</th>
<th>Name</th>
<th>Weekly %</th>
<th>Overall %</th>
<th>Call</th>
</tr>
</thead>

<tbody>

{% for c in records %}
<tr>

<td>{{c.student.roll_no}}</td>
<td>{{c.student.enrollment}}</td>
<td>{{c.student.name}}</td>

{% with a=attendance_map|get_item:c.student.id %}
<td class="text-center {% if a and a.week_percentage < 80 %}text-danger fw-bold{% endif %}">
    {{a.week_percentage}}%
</td>

<td class="text-center {% if a and a.overall_percentage < 80 %}text-danger fw-bold{% endif %}">
    {{a.overall_percentage}}%
</td>
{% endwith %}

<td class="text-center">
    <button class="btn btn-success call-btn"
        data-id="{{c.id}}"
        data-phone="{{c.student.father_mobile|default:c.student.mother_mobile}}">
		ðŸ“ž CALL
	</button>

</td>

</tr>
{% endfor %}

</tbody>
</table>
</div>

</div>


<!-- ================= MOBILE CARDS ================= -->
<div class="mobile-view">

{% for c in records %}
{% with a=attendance_map|get_item:c.student.id %}

<div class="card shadow-sm mb-3">

    <div class="card-body p-3">

        <div class="fw-bold fs-6">
            {{c.student.roll_no}} â€” {{c.student.name}}
        </div>

        <div class="text-muted small mb-2">
            {{c.student.enrollment}}
        </div>

        <div class="d-flex justify-content-between mb-2">

            <div>
                Weekly<br>
                <span class="fw-bold {% if a and a.week_percentage < 80 %}text-danger{% else %}text-success{% endif %}">
                    {{a.week_percentage}}%
                </span>
            </div>

            <div>
                Overall<br>
                <span class="fw-bold {% if a and a.overall_percentage < 80 %}text-danger{% else %}text-success{% endif %}">
                    {{a.overall_percentage}}%
                </span>
            </div>

        </div>

        <button class="btn btn-success w-100 call-btn"
				data-id="{{c.id}}"
				data-phone="{{c.student.father_mobile|default:c.student.mother_mobile}}">
			ðŸ“ž Call Parent
		</button>


    </div>
</div>

{% endwith %}
{% endfor %}

</div>

<script>
const PENDING_CALL_KEY = "pending_call";
let modalShownForPending = false;

function getPendingCall(){
    try{
        return JSON.parse(localStorage.getItem(PENDING_CALL_KEY) || "null");
    }catch(e){
        return null;
    }
}

function setPendingCall(data){
    localStorage.setItem(PENDING_CALL_KEY, JSON.stringify(data));
    modalShownForPending = false;
}

function clearPendingCall(){
    localStorage.removeItem(PENDING_CALL_KEY);
    modalShownForPending = false;
}

function openCallResultModalIfPending(){
    const pending = getPendingCall();
    if(!pending || modalShownForPending){
        return;
    }
    if(!pending.id){
        clearPendingCall();
        return;
    }

    const startedAt = Number(pending.started_at || 0);
    const elapsedSec = startedAt ? Math.max(0, Math.round((Date.now() - startedAt) / 1000)) : 0;
    const estimatedMinutes = elapsedSec ? Math.max(1, Math.round(elapsedSec / 60)) : "";

    document.getElementById("call_id").value = pending.id;
    document.getElementById("duration").value = estimatedMinutes;
    document.getElementById("autoDurationNote").innerText =
        elapsedSec ? `Auto-estimated duration: ${elapsedSec}s (editable)` : "";

    modalShownForPending = true;
    new bootstrap.Modal(document.getElementById("callResultModal")).show();
}

document.querySelectorAll(".call-btn").forEach(btn => {
    btn.addEventListener("click", function(){
        const phone = (this.dataset.phone || "").trim();
        const callId = this.dataset.id;

        if(!phone){
            alert("Parent number not available");
            return;
        }

        setPendingCall({
            id: callId,
            phone: phone,
            started_at: Date.now()
        });

        window.location.href = "tel:" + phone;
    });
});

window.addEventListener("focus", function(){
    setTimeout(openCallResultModalIfPending, 350);
});

window.addEventListener("pageshow", function(){
    setTimeout(openCallResultModalIfPending, 350);
});

document.addEventListener("visibilitychange", function(){
    if(document.visibilityState === "visible"){
        setTimeout(openCallResultModalIfPending, 350);
    }
});
</script>

<script>

function markReceived(){

    let id = document.getElementById("call_id").value;
    let talked = document.getElementById("talked").value;
    let duration = document.getElementById("duration").value;
    let reason = document.getElementById("reason").value;

    fetch("/save-call/",{
        method:"POST",
        headers:{
            "Content-Type":"application/x-www-form-urlencoded",
            "X-CSRFToken":"{{csrf_token}}"
        },
        body:`id=${id}&status=received&talked=${talked}&duration=${duration}&reason=${reason}`
    }).then(()=>{
        clearPendingCall();
        location.reload();
    });
}

function markNotReceived(){

    let id = document.getElementById("call_id").value;

    fetch("/save-call/",{
        method:"POST",
        headers:{
            "Content-Type":"application/x-www-form-urlencoded",
            "X-CSRFToken":"{{csrf_token}}"
        },
        body:`id=${id}&status=not_received`
    }).then(()=>{
        clearPendingCall();
        location.reload();
    });
}

</script>

<!-- CALL RESULT MODAL -->
<div class="modal fade" id="callResultModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Call Result</h5>
      </div>

      <div class="modal-body">

        <input type="hidden" id="call_id">

        <div class="mb-2">
            <label>Talked With</label>
            <select id="talked" class="form-control">
                <option value="father">Father</option>
                <option value="mother">Mother</option>
                <option value="guardian">Guardian</option>
            </select>
        </div>

        <div class="mb-2">
            <label>Duration (minutes)</label>
            <input type="number" id="duration" class="form-control" min="1">
            <small id="autoDurationNote" class="text-muted"></small>
        </div>

        <div class="mb-2">
            <label>Parent Remark</label>
            <input type="text" id="reason" class="form-control">
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-success w-100" onclick="markReceived()">Received</button>
            <button class="btn btn-danger w-100" onclick="markNotReceived()">Not Received</button>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- NOT CONNECTED POPUP -->
<div class="modal fade" id="retryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Call Again Reminder</h5>
      </div>

      <div class="modal-body">

        <p>The following parents were not connected:</p>

        <ul class="list-group">

			{% for c in not_connected %}
			{% with a=attendance_map|get_item:c.student.id %}

			<li class="list-group-item d-flex justify-content-between align-items-center">

				<div>
					<b>{{c.student.roll_no}} - {{c.student.name}}</b><br>
					<small>Weekly: {{a.week_percentage}}% | Overall: {{a.overall_percentage}}%</small>
				</div>

				<div class="d-flex gap-2">

					<a href="tel:{{c.student.father_mobile|default:c.student.mother_mobile}}"
					   class="btn btn-sm btn-warning">
					   ðŸ“ž
					</a>

					<a target="_blank"
					   href="https://wa.me/{{c.student.father_mobile|default:c.student.mother_mobile}}?text=Dear%20Parent,%0A%0AYour%20ward%20{{c.student.name|urlencode}}%20(Roll%20{{c.student.roll_no}})%20attendance%20is%20below%2080%%.%0A%0AWeekly:%20{{a.week_percentage}}%%0AOverall:%20{{a.overall_percentage}}%%0A%0APlease%20ensure%20regular%20attendance.%0A%0AL.J.%20Institute%20of%20Engineering%20%26%20Technology"
					   class="btn btn-sm btn-success">
					   ðŸ’¬
					</a>

				</div>

			</li>

			{% endwith %}
			{% endfor %}

		</ul>


      </div>

    </div>
  </div>
</div>

{% if all_done and not_connected %}
<script>
window.onload = function(){
    new bootstrap.Modal(document.getElementById('retryModal')).show();
}
</script>
{% endif %}

{% endblock %}
